{% extends "base.html" %}
{% load staticfiles %}

{% block title %} Move - {{ move.name }}{% endblock %}
{% block header %} Move: {{ move.name }}{% endblock %}
{% block content %}
{{ move.name }} is comprised of the following components:
<br />
<ul class="footbag_sequence">
    {% for comp in sequence %}
    <li><a href="{% url "component_detail" comp.component.slug %}"> {{comp.component.name}}</a> </li>
    {% endfor %}
</ul>

{% if load_youtube %}
<script src="{% static 'js/load_youtube.js' %}"></script>
{% endif %}

<div id="player"></div>

{% if load_youtube %}
<script>
var player;
youtube_ready = function(){
    //Youtube ID of the first video to be loaded in the player along with the page
    var first_vid_id = "{{ first_yt_id }}";
    player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: first_vid_id,
        events: {
            'onReady': onPlayerReady
        }
    });
}

</script>
{% endif %}

<br />
<br />
<div class="demonstration_videos">
{% with videos=video_demo.all %}
    {% if videos %}
        Video demonstration:<br />
        <ul>
        {% for vid in videos %}
            {% if vid.video_type == vid_type_external %}
                <li><a href="{{ vid.URL }}" class="vidtype{{ vid.video_type }}"> click for demonstration (external link)</a></li>
            {% else %}
                <li><a href="{{ vid.URL }}" class="vidtype{{ vid.video_type }}"> click for demonstration </a></li>
            {% endif %}
        {% endfor %}
        </ul>
    {% else %}
        No video demonstrations found.
    {% endif %}
{% endwith %}
</div>

<br />
<div class="tutorial_videos">
{% with videos=video_tutorial.all %}
    {% if videos %}
        Tutorial video:<br />
        <ul>
        {% for vid in videos %}
            {% if vid.video_type == vid_type_external %}
                <li><a href="{{ vid.URL }}" class="vidtype{{ vid.video_type }}"> click for tutorial (external link)</a></li>
            {% else %}
                <li><a href="{{ vid.URL }}" class="vidtype{{ vid.video_type }}"> click for tutorial </a></li>
            {% endif %}
        {% endfor %}
        </ul>
    {% else %}
        No video tutorials found.
    {% endif %}
{% endwith %}
</div>

<script>
/*Extract youtube ID from a complete youtube link.
Formats supported:

    latest short format: http://youtu.be/-E1DwhGH8FE
    nocookie domain: http://www.youtube-nocookie.com
    iframe: http://www.youtube.com/embed/-E1DwhGH8FE
    iframe (secure): https://www.youtube.com/embed/-E1DwhGH8FE
    object param: http://www.youtube.com/v/-E1DwhGH8FE?fs=1&hl=en_US
    object embed: http://www.youtube.com/v/-E1DwhGH8FE?fs=1&hl=en_US
    watch: http://www.youtube.com/watch?v=-E1DwhGH8FE
    any/subdomain/too: http://gdata.youtube.com/feeds/api/videos/-E1DwhGH8FE
    more params: http://www.youtube.com/watch?v=-E1DwhGH8FE&feature=g-vrec
    query may have dot: http://www.youtube.com/watch?v=-E1DwhGH8FE&feature=youtu.be

ID for the video is assumed to be exactly 11 characters long.

Regex solution based on http://stackoverflow.com/questions/5830387/
*/
function extractYouTubeID(url_text) {
    var re = /https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com\S*[^\w\s-])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/ig;
    var id_match = re.exec(url_text);
    return id_match[1];
}

//A function to prevent the default behaviour of an event,
//used to prevent href from being followed when we are updating a video in the player
function cancelDefaultAction(e) {
    var evt = e ? e:window.event;
    if (evt.preventDefault) evt.preventDefault();
    evt.returnValue = false;
    return false;
}

//Get all the demo/tutorial links that contain a youtube video
var yt_vid_class = document.getElementsByClassName("vidtype{{vid_type_yt}}");

//Function that's called whenever a youtube video link is clicked
var ytVidFunction = function(evt) {
    var attribute = this.getAttribute("href");
    player.loadVideoById(extractYouTubeID(attribute));
    cancelDefaultAction(evt);
};

//Register listener for each youtube link
for(var i=0;i<yt_vid_class.length;i++){
    yt_vid_class[i].addEventListener('click', ytVidFunction, false);
}
</script>
{% endblock %}
